---
title: "Final Project - Christophe"
author: "Christophe Hunt"
date: "April 23, 2016"
output: html_document
---

Need to run only this chunk (`Twitter Setup`) first because you need to but in a PIN given by Twitter.  

```{r, Twitter Setup}
library(twitteR)
library(httr)
library(ROAuth)

consumer_key <- "vPOqiiCwFT9N1iXNP24y2stmc"
consumer_secret <- "IPE1ct2pu4E633Y9OoQ35V9AeLZ1oU4UKlfNb2A0lvbwZZ2jil"
access_token <- "4228029732-Ax9gP4SArwAIxnJK0pIFVsBmHhIBFTcHbn0dsvJ"
access_secret <- "1lp8uHBeK0VTuog9wOfbtIBxXWrnKoqin6sTCUg9ogJNu"

download.file(url='http://curl.haxx.se/ca/cacert.pem', destfile='cacert.pem')
reqURL <- 'https://api.twitter.com/oauth/request_token'
accessURL <- 'https://api.twitter.com/oauth/access_token'
authURL <- 'https://api.twitter.com/oauth/authorize'
Cred <- OAuthFactory$new(consumerKey=consumer_key,
                         consumerSecret=consumer_secret,
                         requestURL=reqURL,
                         accessURL=accessURL,
                         authURL=authURL)

Cred$handshake(cainfo = system.file('CurlSSL', 
                                    'cacert.pem', 
                                    package = 'RCurl'))
```

Run the following chunks after entering the PIN for Twitter Authorization.

```{r}
save(Cred, file='twitter authentication.Rdata')
load('twitter authentication.Rdata') 
setup_twitter_oauth(consumer_key, 
                    consumer_secret, 
                    access_token, 
                    access_secret)
```

This chunk gets the twitter search results for a term, `searchTwitter` has some other settings that could probably improve results.

```{r, Searching Twitter}
search_term <- function(term){
  search_term <- gsub(" ", "+", term)
  return(search_term)
}
  
SearchTerm <- search_term("BarberShop: The Next Cut")
list <- searchTwitter(SearchTerm, n = 100, lang = "en")
df <- twListToDF(list)

```



```{r}
library(magrittr)
library(tm)

rm_special <-function(x) iconv(x, "UTF-8", "UTF-8",sub='')


corpus  <- Corpus(VectorSource(df$text))                %>%
           tm_map(rm_special)                           %>%
           tm_map(removePunctuation)                    %>%
           tm_map(tolower)                              %>%
           tm_map(removeNumbers)                        %>%
           tm_map(removeWords, stopwords("english"))  

library(h2o)
library(qdap)
                       
polarity(
  sentSplit(df$text, stem.col = TRUE)
         , grouping.var = NULL,
polarity.frame = qdapDictionaries::key.pol, constrain = FALSE,
negators = qdapDictionaries::negation.words,
amplifiers = qdapDictionaries::amplification.words,
deamplifiers = qdapDictionaries::deamplification.words,
question.weight = 0, amplifier.weight = 0.8, n.before = 4,
n.after = 2, rm.incomplete = FALSE, digits = 3)

```

```{r}

#http://www.inside-r.org/howto/mining-twitter-airline-consumer-sentiment
pos.words = scan('http://www.idiap.ch/~apbelis/hlt-course/positive-words.txt',what='character', comment.char=';')
neg.words = scan('http://www.idiap.ch/~apbelis/hlt-course/negative-words.txt',what='character', comment.char=';')

score.sentiment = function(tweets, pos.words, neg.words)
{
scores = laply(tweets, function(tweets, pos.words, neg.words) {
word.list = str_split(tweets, '\\s+')
words = unlist(word.list)
pos.matches = match(words, pos.words)
neg.matches = match(words, neg.words)
pos.matches = !is.na(pos.matches)
neg.matches = !is.na(neg.matches)
score = sum(pos.matches) - sum(neg.matches)

return(score)
}, pos.words, neg.words)

scores.df = data.frame(score=scores, text=tweets)
return(scores.df)
}

x <- as.data.frame(score.sentiment(as.character(rm_special(df$text)), pos.words, neg.words))

library(knitr)
kable(x)


```
```{r}
library(httr)
library(RCurl)
alchemy_url <- "http://access.alchemyapi.com/calls/url/"
api_feature <- "URLGetTextSentiment"
the_url <- "https://dreamtolearn.com/node/8OVIWY2C5RLZZSYD9OHCKM8AI/80"
api_key <- "dbd2420ad27fb76303d57fbb2c7d9de7e7b0950c"  # alchemy API secret key 

temp <- paste(alchemy_url,api_feature,"?url=",gsub(" ", "+", rm_special(df$text[1])),"&apikey=",api_key,"&outputMode=json", sep="")
temp
POST(temp)
```